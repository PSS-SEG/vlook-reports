<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç™»å…¥æŸ¥è©¢ç³»çµ±</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h2, h3 {
      color: #333;
    }
    form {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      max-width: 600px;
    }
    input, button {
      margin: 5px 10px 5px 0;
      padding: 6px;
    }
    table {
      border-collapse: collapse;
      margin-bottom: 20px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <h2>é›²ç«¯ç³»çµ±ç™»å…¥</h2>
  <form id="cloudForm">
    <input type="text" name="username" placeholder="å¸³è™Ÿ" required />
    <input type="password" name="password" placeholder="å¯†ç¢¼" required />
    <input type="date" name="start_date" required />
    <input type="date" name="end_date" required />
    <input type="text" name="lotId" placeholder="å ´åœ°ä»£è™Ÿï¼ˆå¦‚ PSS_IC0854ï¼‰" required />
    <button type="submit">æŸ¥è©¢</button>
  </form>

  <h2>å°å¸³ç³»çµ±ç™»å…¥</h2>
  <form id="recForm">
    <input type="text" name="username" placeholder="å¸³è™Ÿ" required />
    <input type="password" name="password" placeholder="å¯†ç¢¼" required />
    <input type="date" name="start_date" required />
    <input type="date" name="end_date" required />
    <button type="submit">æŸ¥è©¢</button>
  </form>

  <hr />
  <h3>çµæœ</h3>
  <div id="result"></div>

  <script>
  const resultBox = document.getElementById('result');

  function createTable(title, data) {
    if (data.length === 0) return '';
    let html = `<h4>${title}ï¼ˆå…± ${data.length} ç­†ï¼‰</h4>`;
    html += `<table><thead>
      <tr><th>æ—¥æœŸ</th><th>å ´åœ°ä»£è™Ÿ</th><th>å ´åœ°åç¨±</th><th>æ”¯ä»˜æ–¹å¼</th><th>ç•°å¸¸åŸå› </th></tr>
    </thead><tbody>`;
    data.forEach(row => {
      html += `<tr>
        <td>${row.date || ''}</td>
        <td>${row.site_id || ''}</td>
        <td>${row.site_name || ''}</td>
        <td>${row.card_type || ''}</td>
        <td>${row.reason || ''}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    return html;
  }

  function summarizeByType(data) {
    const summary = {};
    data.forEach(row => {
      const key = row.card_type || 'æœªçŸ¥æ”¯ä»˜æ–¹å¼';
      summary[key] = (summary[key] || 0) + 1;
    });
    return summary;
  }

  function displaySummary(title, data) {
    const summary = summarizeByType(data);
    let html = `<p><strong>${title} çµ±è¨ˆï¼š</strong>`;
    for (const [type, count] of Object.entries(summary)) {
      html += `${type}: ${count} ç­†ã€€`;
    }
    html += `ç¸½è¨ˆï¼š${data.length} ç­†</p>`;
    return html;
  }

  function handleSubmit(endpoint, form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      resultBox.innerHTML = "æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...";

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const json = await res.json();
        console.log("âœ… Received JSON:", json);

        let html = "";

        // v1: å¦‚æœæ˜¯æ–°æ ¼å¼ï¼Œä½¿ç”¨ json.bothIssues çµæ§‹
        if (json.bothIssues || json.onlyDiff || json.onlyTotal) {
          const both = json.bothIssues || [];
          const onlyDiff = json.onlyDiff || [];
          const onlyZero = json.onlyTotal || [];

          html += createTable("â— åŒæ™‚ç¬¦åˆå…©æ¢ä»¶", both);
          html += displaySummary("åŒæ™‚ç•°å¸¸", both);
          html += createTable("ğŸ”º åœ¨é€”ç‡Ÿæ”¶ç‚ºè² æ•¸", onlyDiff);
          html += displaySummary("åœ¨é€”ç‡Ÿæ”¶ç•°å¸¸", onlyDiff);
          html += createTable("ğŸ”µ æœŸé–“ç‡Ÿæ”¶ç‚º 0", onlyZero);
          html += displaySummary("æœŸé–“ç‡Ÿæ”¶ç•°å¸¸", onlyZero);

          if (!both.length && !onlyDiff.length && !onlyZero.length) {
            html = "<p>âœ… æ²’æœ‰ç•°å¸¸è³‡æ–™ï¼</p>";
          }

        } else if (Array.isArray(json)) {
          // v2: èˆŠæ ¼å¼ï¼Œè™•ç† payload çµæ§‹
          const onlyDiff = [], onlyZero = [], both = [];

          json.forEach(({ card_type, data }) => {
            if (!data || !data.payload) return;
            data.payload.forEach(site => {
              const { site_id, site_name, details } = site;
              if (!details || !details.length) return;

              details.forEach(d => {
                const diffNeg = d.diff_amount < 0;
                const totalZero = d.total_amount === 0;

                if (diffNeg && totalZero) {
                  both.push({ date: d.date, site_id, site_name, card_type, reason: "åœ¨é€”ç‡Ÿæ”¶ç‚ºè² æ•¸ã€æœŸé–“ç‡Ÿæ”¶ç‚º0" });
                } else if (diffNeg) {
                  onlyDiff.push({ date: d.date, site_id, site_name, card_type, reason: "åœ¨é€”ç‡Ÿæ”¶ç‚ºè² æ•¸" });
                } else if (totalZero) {
                  onlyZero.push({ date: d.date, site_id, site_name, card_type, reason: "æœŸé–“ç‡Ÿæ”¶ç‚º0" });
                }
              });
            });
          });

          html += createTable("â— åŒæ™‚ç¬¦åˆå…©æ¢ä»¶", both);
          html += displaySummary("åŒæ™‚ç•°å¸¸", both);
          html += createTable("ğŸ”º åœ¨é€”ç‡Ÿæ”¶ç‚ºè² æ•¸", onlyDiff);
          html += displaySummary("åœ¨é€”ç‡Ÿæ”¶ç•°å¸¸", onlyDiff);
          html += createTable("ğŸ”µ æœŸé–“ç‡Ÿæ”¶ç‚º 0", onlyZero);
          html += displaySummary("æœŸé–“ç‡Ÿæ”¶ç•°å¸¸", onlyZero);

          if (!both.length && !onlyDiff.length && !onlyZero.length) {
            html = "<p>âœ… æ²’æœ‰ç•°å¸¸è³‡æ–™ï¼</p>";
          }

        } else {
          html = "<p>âš ï¸ ç„¡æ³•è¾¨è­˜å›å‚³è³‡æ–™æ ¼å¼</p>";
        }

        resultBox.innerHTML = html;

      } catch (err) {
        resultBox.innerHTML = `<p>âŒ éŒ¯èª¤ï¼š${err.message}</p>`;
        console.error('ğŸ”¥ Fetch error:', err);
      }
    });
  }

  handleSubmit('/api/cloud/login', document.getElementById('cloudForm'));
  handleSubmit('/api/rec/login', document.getElementById('recForm'));
</script>
</body>
</html>
