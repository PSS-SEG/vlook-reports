<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç™»å…¥æŸ¥è©¢ç³»çµ±</title>
  <style>
    /* åŸºæœ¬æ¨£å¼ */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h2, h3 {
      color: #333;
    }

    h4 {
      margin-top: 20px;
    }

    h4::before {
      content: "ğŸ” ";
    }

    /* è¡¨å–®æ¨£å¼ */
    form {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      max-width: 800px;
    }

    input, button {
      margin: 0px 10px 0px 0;
      padding: 6px;
    }

    /* è¡¨æ ¼æ¨£å¼ */
    table {
      border-collapse: collapse;
      margin-bottom: 20px;
      width: auto;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }
  </style>
</head>

<body>
  <!-- é›²ç«¯ç³»çµ±ç™»å…¥è¡¨å–® -->
  <h2>é›²ç«¯ç³»çµ±ç™»å…¥</h2>
  <form id="cloudForm">
    <input type="text" name="username" placeholder="å¸³è™Ÿ" required />
    <input type="password" name="password" placeholder="å¯†ç¢¼" required />
    <input type="date" name="start_date" required />
    <input type="date" name="end_date" required />
    <input type="text" name="lotId" placeholder="å ´åœ°ä»£è™Ÿï¼ˆå¦‚ PSS_IC0854ï¼‰" required />
    <button type="submit">æŸ¥è©¢</button>
  </form>

  <!-- å°å¸³ç³»çµ±ç™»å…¥è¡¨å–® -->
  <h2>å°å¸³ç³»çµ±ç™»å…¥</h2>
  <form id="recForm">
    <input type="text" name="username" placeholder="å¸³è™Ÿ" required />
    <input type="password" name="password" placeholder="å¯†ç¢¼" required />
    <input type="date" name="start_date" required />
    <input type="date" name="end_date" required />
    <button type="submit">æŸ¥è©¢</button>
  </form>

  <!-- ç™½åå–®å€å¡Š -->
  <h3>å°å¸³ç³»çµ±ç™½åå–®(å¡«å…¥ä¸éœ€æª¢æŸ¥çš„å ´åœ°å¾Œå„²å­˜)</h3>
  <form onsubmit="saveWhitelist(); return false;" style="display: flex; align-items: flex-end; gap: 10px;">
    <textarea id="whiteListInput" rows="4" style="width: 400px;" placeholder="æ¯å¯«ä¸€å€‹å ´åœ°ä»£è™Ÿå°±æ›è¡Œï¼ŒEX:PSS_XXX"></textarea>
    <button type="button" onclick="saveWhitelist()">å„²å­˜ç™½åå–®</button>
  </form>

  <hr />
  <!-- æŸ¥è©¢çµæœé¡¯ç¤ºå€ -->
  <h3>æª¢æŸ¥çµæœ</h3>
  <div id="result"></div>

  <script>
    const resultBox = document.getElementById('result');

    // å»ºç«‹çµæœè¡¨æ ¼å‡½å¼
    function createTable(title, data) {
      if (data.length === 0) return '';
      let html = `<h4>${title}ï¼ˆå…± ${data.length} ç­†ï¼‰</h4>`;
      html += `<table><thead>
        <tr><th>æ—¥æœŸ</th><th>å ´åœ°ä»£è™Ÿ</th><th>å ´åœ°åç¨±</th><th>æ”¯ä»˜æ–¹å¼</th><th>ç•°å¸¸åŸå› </th></tr>
      </thead><tbody>`;
      data.forEach(row => {
        html += `<tr>
          <td>${row.date || ''}</td>
          <td>${row.site_id || ''}</td>
          <td>${row.site_name || ''}</td>
          <td>${row.card_type || ''}</td>
          <td>${row.reason || ''}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      return html;
    }

    // æ ¹æ“šæ”¯ä»˜æ–¹å¼åˆ†é¡çµ±è¨ˆç­†æ•¸
    function summarizeByType(data) {
      const summary = {};
      data.forEach(row => {
        const key = row.card_type || 'æœªçŸ¥æ”¯ä»˜æ–¹å¼';
        summary[key] = (summary[key] || 0) + 1;
      });
      return summary;
    }

    // é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦
    function displaySummary(title, data) {
      const summary = summarizeByType(data);
      let html = `<p><strong>${title} çµ±è¨ˆï¼š</strong>`;
      for (const [type, count] of Object.entries(summary)) {
        html += `${type}: ${count} ç­†ã€€`;
      }
      html += `ç¸½è¨ˆï¼š${data.length} ç­†</p>`;
      return html;
    }

    // å„²å­˜ç™½åå–®åˆ° localStorage
    function saveWhitelist() {
      const list = document.getElementById('whiteListInput').value
        .split('\n')                 // ä»¥æ›è¡Œåˆ†å‰²
        .map(line => line.trim())   // å»é™¤ç©ºç™½
        .filter(Boolean);           // éæ¿¾ç©ºè¡Œ
      localStorage.setItem('whitelist', JSON.stringify(list));
      alert('ç™½åå–®å·²å„²å­˜');
      document.getElementById('whiteListInput').value = list.join('\n');
    }

    // é é¢è¼‰å…¥æ™‚è¼‰å…¥ç™½åå–®
    window.onload = () => {
      const saved = localStorage.getItem('whitelist');
      if (saved) {
        document.getElementById('whiteListInput').value = JSON.parse(saved).join('\n');
      }
    };

    // è™•ç†è¡¨å–®æäº¤ä¸¦ç™¼é€è«‹æ±‚
    function handleSubmit(endpoint, form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // å°‡è¡¨å–®è³‡æ–™è½‰æ›ç‚º JSON
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const whitelist = JSON.parse(localStorage.getItem('whitelist') || '[]');
        data.whitelist = whitelist;

        resultBox.innerHTML = "æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...";

        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });

          const json = await res.json();
          console.log("âœ… Received JSON:", json);

          let html = "";

          // v1: æ–°ç‰ˆæ ¼å¼è™•ç†
          if (json.bothIssues || json.onlyDiff || json.onlyTotal) {
            const both = json.bothIssues || [];
            const onlyDiff = json.onlyDiff || [];
            const onlyZero = json.onlyTotal || [];

            html += createTable("â— åŒæ™‚ç¬¦åˆå…©æ¢ä»¶", both);
            html += displaySummary("åŒæ™‚ç•°å¸¸", both);
            html += createTable("ğŸ”º åœ¨é€”ç‡Ÿæ”¶ç‚ºè² æ•¸", onlyDiff);
            html += displaySummary("åœ¨é€”ç‡Ÿæ”¶ç•°å¸¸", onlyDiff);
            html += createTable("ğŸ”µ æœŸé–“ç‡Ÿæ”¶ç‚º 0", onlyZero);
            html += displaySummary("æœŸé–“ç‡Ÿæ”¶ç•°å¸¸", onlyZero);

            if (!both.length && !onlyDiff.length && !onlyZero.length) {
              html = "<p>âœ… æ²’æœ‰ç•°å¸¸è³‡æ–™ï¼</p>";
            }

          // å…¶ä»–æœªçŸ¥æ ¼å¼
          } else {
            html = "<p>âš ï¸ ç„¡æ³•è¾¨è­˜å›å‚³è³‡æ–™æ ¼å¼</p>";
          }

          resultBox.innerHTML = html;

        } catch (err) {
          // éŒ¯èª¤è™•ç†
          resultBox.innerHTML = `<p>âŒ éŒ¯èª¤ï¼š${err.message}</p>`;
          console.error('ğŸ”¥ Fetch error:', err);
        }
      });
    }

    // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
    handleSubmit('/api/cloud/login', document.getElementById('cloudForm'));
    handleSubmit('/api/rec/login', document.getElementById('recForm'));
  </script>
</body>
</html>
